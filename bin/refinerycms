#!/usr/bin/env ruby
gem 'railties'
require 'rails/generators'
require 'rails/generators/rails/app/app_generator'
require File.expand_path('../../core/lib/generators/refinery/cms/cms_generator', __FILE__)
template_path = File.expand_path('../../templates/refinery/installer.rb', __FILE__)

if ARGV.size == 0 || ARGV[0] == "--help"
  puts "Usage:"
  puts "  refinerycms APP_NAME [options]"
  puts ""
  puts "Options:"
  options = Refinery::CmsGenerator.class_options
  options.keys.each do |option_key|
    puts "  --#{option_key}".ljust(28) << "# #{options[option_key].description}"
  end
  exit(0)
end

application_name = ARGV.shift

result = Rails::Generators::AppGenerator.start [application_name, '-m', template_path, '--skip-test-unit'] | ARGV

if result && result.include?('Gemfile')
  note = ["\n=== ACTION REQUIRED ==="]
  note << "Now you can launch your webserver using:"
  note << "\ncd #{application_name}"
  note << "rails server"
  note << "\nThis will launch the built-in webserver at port 3000."
  note << "You can now see Refinery running in your browser at http://localhost:3000/refinery"

  if ARGV.include?('--heroku')
    note << "\nIf you want files and images to work on Heroku, you will need setup S3:"
    note << "heroku config:add S3_BUCKET=XXXXXXXXX S3_KEY=XXXXXXXXX S3_SECRET=XXXXXXXXXX S3_REGION=XXXXXXXXXX"
  end

  note << "\nThanks for installing Refinery CMS, we hope you enjoy crafting your application!"
  note << "---------\n\n"

  puts note
end
